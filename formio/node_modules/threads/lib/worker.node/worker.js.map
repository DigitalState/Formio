{"version":3,"sources":["worker.node/worker.js"],"names":["Worker","initialRunnable","options","slave","fork","join","__dirname","on","handleMessage","bind","handleError","emit","run","toRun","runMethod","runScript","method","send","initByMethod","toString","script","Error","prefixedScriptPath","basepath","node","initByScript","resolve","param","doRun","kill","promise","Promise","reject","resolved","rejected","result","removeListener","err","once","message","error","stack","progress","handleProgress","response","listeners","console"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;;;;;;;IAGqBA,M;;;AACnB,kBAAYC,eAAZ,EAA2C;AAAA,QAAdC,OAAc,uEAAJ,EAAI;;AAAA;;AAAA,iDACzC,wBADyC;;AAGzC,UAAKC,KAAL,GAAa,wBAAMC,IAAN,CAAW,eAAKC,IAAL,CAAUC,SAAV,EAAqB,UAArB,CAAX,EAA6C,EAA7C,EAAiDJ,OAAjD,CAAb;AACA,UAAKC,KAAL,CAAWI,EAAX,CAAc,SAAd,EAAyB,MAAKC,aAAL,CAAmBC,IAAnB,OAAzB;AACA,UAAKN,KAAL,CAAWI,EAAX,CAAc,OAAd,EAAuB,MAAKG,WAAL,CAAiBD,IAAjB,OAAvB;AACA,UAAKN,KAAL,CAAWI,EAAX,CAAc,MAAd,EAAsB,MAAKI,IAAL,CAAUF,IAAV,QAAqB,MAArB,CAAtB;;AAEA,QAAIR,eAAJ,EAAqB;AACnB,YAAKW,GAAL,CAASX,eAAT;AACD;AAVwC;AAW1C;;mBAEDW,G,gBAAIC,K,EAAO;AACT,QAAI,OAAOA,KAAP,KAAiB,UAArB,EAAiC;AAC/B,WAAKC,SAAL,CAAeD,KAAf;AACD,KAFD,MAEO;AACL,WAAKE,SAAL,CAAeF,KAAf;AACD;AACD,WAAO,IAAP;AACD,G;;mBAEDC,S,sBAAUE,M,EAAQ;AAChB,SAAKb,KAAL,CAAWc,IAAX,CAAgB;AACdC,oBAAe,IADD;AAEdF,cAAeA,OAAOG,QAAP;AAFD,KAAhB;AAID,G;;mBAEDJ,S,sBAAUK,M,EAAQ;AAChB,QAAI,CAACA,MAAL,EAAa;AAAE,YAAM,IAAIC,KAAJ,CAAU,iDAAV,CAAN;AAAqE;;AAEpF,QAAMC,qBAAqB,eAAKjB,IAAL,CAAU,yBAAYkB,QAAZ,CAAqBC,IAA/B,EAAqCJ,MAArC,CAA3B;;AAEA;AACA,SAAKjB,KAAL,CAAWc,IAAX,CAAgB;AACdQ,oBAAe,IADD;AAEdL,cAAe,eAAKM,OAAL,CAAaJ,kBAAb;AAFD,KAAhB;AAID,G;;mBAEDL,I,iBAAKU,K,EAAO;AACV,SAAKxB,KAAL,CAAWc,IAAX,CAAgB;AACdW,aAAQ,IADM;AAEdD;AAFc,KAAhB;AAIA,WAAO,IAAP;AACD,G;;mBAEDE,I,mBAAO;AACL,SAAK1B,KAAL,CAAW0B,IAAX;AACA,WAAO,IAAP;AACD,G;;mBAEDC,O,sBAAU;AAAA;;AACR,WAAO,IAAIC,OAAJ,CAAY,UAACL,OAAD,EAAUM,MAAV,EAAqB;AACtC,UAAIC,iBAAJ;AAAA,UAAcC,iBAAd;AACAD,iBAAW,kBAACE,MAAD,EAAY;AACrB,eAAKC,cAAL,CAAoB,OAApB,EAA6BF,QAA7B;AACAR,gBAAQS,MAAR;AACD,OAHD;AAIAD,iBAAW,kBAACG,GAAD,EAAS;AAClB,eAAKD,cAAL,CAAoB,SAApB,EAA+BH,QAA/B;AACAD,eAAOK,GAAP;AACD,OAHD;;AAKA,aACGC,IADH,CACQ,SADR,EACmBL,QADnB,EAEGK,IAFH,CAEQ,OAFR,EAEiBJ,QAFjB;AAGD,KAdM,CAAP;AAeD,G;;mBAED1B,a,0BAAc+B,O,EAAS;AACrB,QAAIA,QAAQC,KAAZ,EAAmB;AACjB,UAAMA,QAAQ,IAAInB,KAAJ,CAAUkB,QAAQC,KAAR,CAAcD,OAAxB,CAAd;AACAC,YAAMC,KAAN,GAAcF,QAAQC,KAAR,CAAcC,KAA5B;;AAEA,WAAK/B,WAAL,CAAiB8B,KAAjB;AACD,KALD,MAKO,IAAID,QAAQG,QAAZ,EAAsB;AAC3B,WAAKC,cAAL,CAAoBJ,QAAQG,QAA5B;AACD,KAFM,MAEA;AACL,WAAK/B,IAAL,cAAU,SAAV,SAAwB4B,QAAQK,QAAhC;AACA,WAAKjC,IAAL,cAAU,MAAV,SAAqB4B,QAAQK,QAA7B,GAFK,CAEsC;AAC5C;AACF,G;;mBAEDD,c,2BAAeD,Q,EAAU;AACvB,SAAK/B,IAAL,CAAU,UAAV,EAAsB+B,QAAtB;AACD,G;;mBAEDhC,W,wBAAY8B,K,EAAO;AACjB,QAAI,CAAC,KAAKK,SAAL,CAAe,OAAf,EAAwB,IAAxB,CAAL,EAAoC;AAClCC,cAAQN,KAAR,CAAcA,MAAMC,KAAN,IAAeD,KAA7B,EADkC,CACS;AAC5C;AACD,SAAK7B,IAAL,CAAU,OAAV,EAAmB6B,KAAnB;AACD,G;;;;;kBAhGkBxC,M","file":"worker.js","sourcesContent":["import child        from 'child_process';\nimport path         from 'path';\nimport EventEmitter from 'eventemitter3';\n\nimport { getConfig } from '../config';\n\n\nexport default class Worker extends EventEmitter {\n  constructor(initialRunnable, options = {}) {\n    super();\n\n    this.slave = child.fork(path.join(__dirname, 'slave.js'), [], options);\n    this.slave.on('message', this.handleMessage.bind(this));\n    this.slave.on('error', this.handleError.bind(this));\n    this.slave.on('exit', this.emit.bind(this, 'exit'));\n\n    if (initialRunnable) {\n      this.run(initialRunnable);\n    }\n  }\n\n  run(toRun) {\n    if (typeof toRun === 'function') {\n      this.runMethod(toRun);\n    } else {\n      this.runScript(toRun);\n    }\n    return this;\n  }\n\n  runMethod(method) {\n    this.slave.send({\n      initByMethod : true,\n      method       : method.toString()\n    });\n  }\n\n  runScript(script) {\n    if (!script) { throw new Error('Must pass a function or a script path to run().'); }\n\n    const prefixedScriptPath = path.join(getConfig().basepath.node, script);\n\n    // attention: single script for node, array for browser\n    this.slave.send({\n      initByScript : true,\n      script       : path.resolve(prefixedScriptPath)\n    });\n  }\n\n  send(param) {\n    this.slave.send({\n      doRun : true,\n      param\n    });\n    return this;\n  }\n\n  kill() {\n    this.slave.kill();\n    return this;\n  }\n\n  promise() {\n    return new Promise((resolve, reject) => {\n      let resolved, rejected;\n      resolved = (result) => {\n        this.removeListener('error', rejected);\n        resolve(result);\n      };\n      rejected = (err) => {\n        this.removeListener('message', resolved);\n        reject(err);\n      };\n\n      this\n        .once('message', resolved)\n        .once('error', rejected);\n    });\n  }\n\n  handleMessage(message) {\n    if (message.error) {\n      const error = new Error(message.error.message);\n      error.stack = message.error.stack;\n\n      this.handleError(error);\n    } else if (message.progress) {\n      this.handleProgress(message.progress);\n    } else {\n      this.emit('message', ...message.response);\n      this.emit('done', ...message.response);    // this one is just for convenience\n    }\n  }\n\n  handleProgress(progress) {\n    this.emit('progress', progress);\n  }\n\n  handleError(error) {\n    if (!this.listeners('error', true)) {\n      console.error(error.stack || error);       // eslint-disable-line no-console\n    }\n    this.emit('error', error);\n  }\n}\n"]}